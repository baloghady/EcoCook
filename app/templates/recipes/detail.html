{% extends 'base.html' %}
{% block title %}{{ recipe.name|title }} - Recipe Details{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
  <div class="flex flex-col md:flex-row gap-6">
    <div class="md:w-1/3">
      {% if recipe.image_url %}
        <img src="/static/{{ recipe.image_url }}" alt="{{ recipe.name }}" class="rounded w-full h-auto mb-4" />
      {% else %}
        <div class="bg-gray-100 rounded w-full h-40 flex items-center justify-center text-gray-400">No image</div>
      {% endif %}
    </div>
    <div class="md:w-2/3">
      <h2 class="text-2xl font-bold mb-2">{{ recipe.name|title }}</h2>
      <p class="mb-2 text-gray-700">{{ recipe.description }}</p>
      <div class="mb-2">
        <span class="font-semibold">Rating:</span> ‚≠ê {{ recipe.average_rating }} / 5
      </div>
      <div class="mb-2">
        <span class="font-semibold">Servings:</span> {{ recipe.servings }}
        <span class="ml-4 font-semibold">Total Time:</span> {{ recipe.total_time }} min
      </div>
      <div class="mb-2">
        <span class="font-semibold">Cuisine:</span> {{ recipe.cuisine }}
        <span class="ml-4 font-semibold">Difficulty:</span> {{ recipe.difficulty }}
      </div>
      {% if recipe.dietary_tags %}
        <div class="mb-2">
          <span class="font-semibold">Tags:</span>
          {% for tag in recipe.dietary_tags %}
            <span class="px-2 py-1 bg-green-100 text-green-800 rounded mr-1">{{ tag }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
  <hr class="my-4" />
  <h3 class="text-lg font-semibold mb-2">Ingredients</h3>
  <ul class="mb-4">
    {% for ing_status in ingredient_status %}
      <li class="mb-1">
        <span class="font-medium">{{ ing_status.name|title }}</span>:
        {{ '%.1f'|format(ing_status.needed) }} {{ ing_status.unit_str }}
        {% if ing_status.is_sufficient %}
          <span class="px-2 py-1 bg-green-100 text-green-800 rounded ml-2 text-sm">
            ‚úì Available ({{ '%.1f'|format(ing_status.available) }}{{ ing_status.unit_str }})
          </span>
        {% elif ing_status.available > 0 %}
          <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded ml-2 text-sm">
            ‚ö† Only {{ '%.1f'|format(ing_status.available) }}{{ ing_status.unit_str }} available (need {{ '%.1f'|format(ing_status.missing) }}{{ ing_status.unit_str }} more)
          </span>
        {% else %}
          <span class="px-2 py-1 bg-red-100 text-red-800 rounded ml-2 text-sm">
            ‚úó Not available
          </span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  <h3 class="text-lg font-semibold mb-2">Instructions</h3>
  <ol class="list-decimal list-inside mb-4">
    {% for step in recipe.instructions %}
      <li class="mb-2">{{ step }}</li>
    {% endfor %}
  </ol>
  {% if recipe.nutrition %}
    <h3 class="text-lg font-semibold mb-2">Nutrition</h3>
    <ul class="mb-4">
      {% for k, v in recipe.nutrition.items() %}
        <li>{{ k|title }}: {{ v }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  <div class="flex gap-3">
    <a href="/recipes/" class="inline-block px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Back to recommendations</a>
    <button type="button" onclick="cookFlow({{ recipe.id }})" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">I cooked it</button>
  </div>

  <script>
    async function cookFlow(recipeId) {
      try {
        const res = await fetch(`/recipes/${recipeId}/cook-check`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await res.json();
        let mode = 'none';
        
        if (data.had_all) {
          const result = await showModal(
            'üéâ All Ingredients Available',
            '<p class="mb-2">You have everything you need to cook this recipe!</p><p>Would you like to add replacement items to your shopping list to restock what you used?</p>',
            [
              { label: 'Cancel', value: 'none', type: 'cancel' },
              { label: 'Add Replacements', value: 'replace', type: 'confirm' }
            ]
          );
          mode = result;
        } else {
          const missingHtml = '<div class="bg-gray-50 rounded p-3 mb-4 border-l-4 border-yellow-500"><p class="font-semibold text-gray-700 mb-2">Missing items:</p><ul class="space-y-1">' + 
            data.missing.map(m => `<li class="text-gray-600">‚Ä¢ <strong>${m.name}</strong>: need ${m.missing} ${m.unit}</li>`).join('') + 
            '</ul></div>';
          const result = await showModal(
            '‚ö†Ô∏è Missing Ingredients',
            missingHtml + '<p>Would you like to add the missing items to your shopping list?</p>',
            [
              { label: 'Cancel', value: 'none', type: 'cancel' },
              { label: 'Add to List', value: 'missing', type: 'confirm' }
            ]
          );
          mode = result;
        }
        
        const cookRes = await fetch(`/recipes/${recipeId}/cook?add_to_list=${mode}`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        window.location.reload();
      } catch (e) {
        console.error(e);
        showToast('Something went wrong while cooking.', 'error');
      }
    }
  </script>
</div>
{% endblock %}
